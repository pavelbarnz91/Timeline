(()=>{"use strict";class t{constructor(t){this.postBox=t}getTextPost(t,e,s){const o=`<div class="post">\n            <div class="post__edit-box">\n                <div class="post__ok edit-box__item hidden"></div>\n                <div class="post__edit edit-box__item"></div>\n                <div class="post__delete edit-box__item"></div>\n            </div>\n\n            <div class="post-text__box">\n                <span class="post-text">${t}</span>\n            </div>\n            \n            <div class="post-information">\n                <div class="post-geolocation">\n                    <span class="post-geolocation__data">${s}</span>\n                </div>\n                <div class="post-time">\n                    <span class="post-geolocation__time">${e}</span>\n                </div>\n            </div>\n        </div>`;document.querySelector(".posts-box__posts").insertAdjacentHTML("afterbegin",o)}getImagePost(t,e,s,o){const i=`\n                <div class="post">\n                    <div class="post__edit-box">\n                        <div class="post__ok edit-box__item hidden"></div>\n                        <div class="post__edit edit-box__item"></div>\n                        <div class="post__delete edit-box__item"></div>\n                    </div>\n\n                    <div class="post-media-box">\n                        <img class="image" src="${o}">\n                    </div>\n\n                    <div class="post-text__box">\n                        <span class="post-text">${t}</span>\n                    </div>\n                    \n                    <div class="post-information">\n                        <div class="post-geolocation">\n                            <span class="post-geolocation__data">${s}</span>\n                        </div>\n                        <div class="post-time">\n                            <span class="post-geolocation__time">${e}</span>\n                        </div>\n                    </div>\n                </div>`;document.querySelector(".posts-box__posts").insertAdjacentHTML("afterbegin",i)}getVideoPost(t,e,s,o){const i=`\n                <div class="post">\n                    <div class="post__edit-box">\n                        <div class="post__ok edit-box__item hidden"></div>\n                        <div class="post__edit edit-box__item"></div>\n                        <div class="post__delete edit-box__item"></div>\n                    </div>\n\n                    <div class="post-media-box">\n                        <video class="video" src="${o}" controls></video>\n                    </div>\n\n                    <div class="post-text__box">\n                        <span class="post-text">${t}</span>\n                    </div>\n                    \n                    <div class="post-information">\n                        <div class="post-geolocation">\n                            <span class="post-geolocation__data">${s}</span>\n                        </div>\n                        <div class="post-time">\n                            <span class="post-geolocation__time">${e}</span>\n                        </div>\n                    </div>\n                </div>`;document.querySelector(".posts-box__posts").insertAdjacentHTML("afterbegin",i)}getAudioPost(t,e,s,o){const i=`\n                <div class="post">\n                    <div class="post__edit-box">\n                        <div class="post__ok edit-box__item hidden"></div>\n                        <div class="post__edit edit-box__item"></div>\n                        <div class="post__delete edit-box__item"></div>\n                    </div>\n\n                    <div class="post-media-box">\n                        <audio class="video" src="${o}" controls></audio>\n                    </div>\n\n                    <div class="post-text__box">\n                        <span class="post-text">${t}</span>\n                    </div>\n                    \n                    <div class="post-information">\n                        <div class="post-geolocation">\n                            <span class="post-geolocation__data">${s}</span>\n                        </div>\n                        <div class="post-time">\n                            <span class="post-geolocation__time">${e}</span>\n                        </div>\n                    </div>\n                </div>`;document.querySelector(".posts-box__posts").insertAdjacentHTML("afterbegin",i)}getModalNotLocation(){document.querySelector(".timeline").insertAdjacentHTML("beforeend",'<div class="not-location-modal-wrapper">\n            <div class="not-location">\n                <span class="not-location__title">К сожалению, нам не удалось получить вше местоположение, пожалуйста, дайте разрешение на использование геолокации, или введите координаты в ручную.</span>\n\n                <div class="not-location-box">\n                    <div class="not-location__geolocation-box">\n                        <span class="geolocation-box__text">Широта и долгота через запятую:</span>\n                        <span class="geolocation-box__text">Формат ввода: [60.4012544, -26.44288]</span>\n                        <input class="geolocation-input" type="text" name="geolocation-input" required>\n                    </div>\n                </div>\n\n                <div class="not-location__btns-box">\n                    <button class="btns-box__ok btns-box-item">Ок</button>\n                    <button class="btns-box__cancel btns-box-item">Отмена</button>\n                </div>\n            </div>\n        </div>')}}function e(t){return/^(\[)?[-+]?([0-9]*[.])?[0-9]+(\s*,\s*|\s+)(-)?([0-9]*[.])?[0-9]+(\])?$/.test(t)?{status:!0,coords:`${t}`}:{status:!1,coords:"Координаты отклонены пользователем."}}new class{constructor(){this.postBox=document.querySelector(".posts-box__posts"),this.textArea=document.querySelector(".input-box__enter-message"),this.sendBtn=document.querySelector(".add-buttons__send"),this.btnsBox=document.querySelector(".input-box__add-buttons"),this.addImageBtn=document.querySelector(".add-buttons__add-file-input"),this.addVideoBtn=document.querySelector(".video-btn"),this.addAudioBtn=document.querySelector(".voice-btn"),this.getPost=new t(this.postBox),this.geoData,this.recorder,this.stream,this.image=null,this.video=null,this.chunks=[],this.startAudio(),this.startVideo(),this.addImage(),this.editPost(),this.enterBtnSend(),this.sendMessage()}enterBtnSend(){this.textArea.addEventListener("keydown",(t=>{if("Enter"===t.key){t.preventDefault();const e=new Event("click");this.sendBtn.dispatchEvent(e)}}))}sendMessage(){this.sendBtn.addEventListener("click",(()=>{const t=this.textArea.value;this.textArea.value="",this.getGeolocation().then((e=>{if(this.image){const s=URL.createObjectURL(this.image);this.getPost.getImagePost(t,this.getDate(),e,s),URL.revokeObjectURL(this.image.src),this.image=null}else this.getPost.getTextPost(t,this.getDate(),e)})).catch((()=>{this.notGeolocation().then((e=>{if(this.geoData){if(this.image){const e=URL.createObjectURL(this.image);this.getPost.getImagePost(t,this.getDate(),this.geoData,e),URL.revokeObjectURL(this.image.src),this.image=null}else this.getPost.getTextPost(t,this.getDate(),this.geoData);this.geoData=null}else this.notGeolocation().then((e=>{if(this.image){const e=URL.createObjectURL(this.image);this.getPost.getImagePost(t,this.getDate(),this.geoData,e),URL.revokeObjectURL(this.image.src),this.image=null}else this.getPost.getTextPost(t,this.getDate(),this.geoData);this.geoData=null}))}))}))}))}getDate(){const t=new Date,e=t.getFullYear(),s=t.getMonth()+1<10?"0"+(t.getMonth()+1):t.getMonth()+1,o=t.getDate()<10?"0"+t.getDate():t.getDate();return`${t.getHours()}:${t.getMinutes()<10?"0"+t.getMinutes():t.getMinutes()} ${o}.${s}.${e}`}getGeolocation(){return new Promise(((t,e)=>{navigator.geolocation.getCurrentPosition((e=>{const{latitude:s,longitude:o}=e.coords;t(`[${s}, ${o}]`)}),(()=>{e("false")}),{enableHighAccuracy:!0})}))}notGeolocation(){return new Promise((t=>{this.getPost.getModalNotLocation();const s=document.querySelector(".not-location-modal-wrapper");s.addEventListener("click",(o=>{if(o.target.classList.contains("btns-box__ok")){const o=e(document.querySelector(".geolocation-input").value);if(o.status)this.removeTooltip(),s.remove(),this.geoData=o.coords,t(o.coords);else{const t=document.querySelector(".geolocation-input");this.showTooltip("Введите корректные данные!",t)}}if(o.target.classList.contains("btns-box__cancel")){const o=e(document.querySelector(".geolocation-input").value);this.removeTooltip(),s.remove(),this.geoData=o.coords,t(o.coords)}}))}))}editPost(){this.postBox.addEventListener("click",(t=>{if(t.target.classList.contains("post__edit")){const e=t.target.closest(".post"),s=e.querySelector(".post__ok"),o=e.querySelector(".post-text__box"),i=o.querySelector(".post-text"),n=document.createElement("textarea");n.classList.add("textarea-edit-post"),n.value=i.textContent,i.classList.add("hidden"),o.append(n),s.classList.remove("hidden")}if(t.target.classList.contains("post__ok")){const e=t.target.closest(".post"),s=e.querySelector(".post__ok"),o=e.querySelector(".post-text"),i=e.querySelector("textarea");o.textContent=i.value,i.remove(),o.classList.remove("hidden"),s.classList.add("hidden")}t.target.classList.contains("post__delete")&&t.target.closest(".post").remove()}))}addImage(){this.addImageBtn.addEventListener("change",(t=>{this.image=t.target.files[0],t.target.value=""}))}recordVideo(){return new Promise((async t=>{if(this.addVideoBtn.classList.contains("add-buttons__stop-video"))return this.textArea.value="",this.addVideoBtn.classList.remove("add-buttons__stop-video"),this.addVideoBtn.classList.add("add-buttons__add-video"),this.recorder.stop(),this.stream.getTracks().forEach((t=>t.stop())),this.recorder=null,void(this.stream=null);this.stream=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),this.recorder=new MediaRecorder(this.stream),this.recorder.addEventListener("dataavailable",(t=>{this.chunks.push(t.data)})),this.recorder.addEventListener("stop",(()=>{const e=this.chunks[this.chunks.length-1];t(URL.createObjectURL(e))})),this.recorder.start(),this.addVideoBtn.classList.remove("add-buttons__add-video"),this.addVideoBtn.classList.add("add-buttons__stop-video")}))}startVideo(){this.addVideoBtn.addEventListener("click",(()=>{const t=this.textArea.value;this.getGeolocation().then((e=>{this.recordVideo().then((s=>this.getPost.getVideoPost(t,this.getDate(),e,s)))})).catch((()=>{this.geoData?(this.recordVideo().then((e=>this.getPost.getVideoPost(t,this.getDate(),this.geoData,e))),this.geoData=null):this.notGeolocation().then((e=>{this.recordVideo().then((s=>this.getPost.getVideoPost(t,this.getDate(),e,s)))}))}))}))}recordAudio(){return new Promise((async t=>{if(this.addAudioBtn.classList.contains("add-buttons__stop-video"))return this.textArea.value="",this.addAudioBtn.classList.remove("add-buttons__stop-video"),this.addAudioBtn.classList.add("add-buttons__add-voice"),this.recorder.stop(),this.stream.getTracks().forEach((t=>t.stop())),this.recorder=null,void(this.stream=null);this.stream=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),this.recorder=new MediaRecorder(this.stream),this.recorder.addEventListener("dataavailable",(t=>{this.chunks.push(t.data)})),this.recorder.addEventListener("stop",(()=>{const e=this.chunks[this.chunks.length-1];this.file=URL.createObjectURL(e),console.log(this.file),t(URL.createObjectURL(e))})),this.recorder.start(),this.addAudioBtn.classList.remove("add-buttons__add-video"),this.addAudioBtn.classList.add("add-buttons__stop-video")}))}startAudio(){this.addAudioBtn.addEventListener("click",(()=>{const t=this.textArea.value;this.getGeolocation().then((e=>{this.recordAudio().then((s=>this.getPost.getAudioPost(t,this.getDate(),e,s)))})).catch((()=>{this.geoData?(this.recordAudio().then((e=>this.getPost.getAudioPost(t,this.getDate(),this.geoData,e))),this.geoData=null):this.notGeolocation().then((e=>{this.recordAudio().then((s=>this.getPost.getAudioPost(t,this.getDate(),e,s)))}))}))}))}showTooltip(t,e){this.removeTooltip();const s=document.createElement("div");s.classList.add("tooltip"),s.textContent=t;const{right:o,top:i}=e.getBoundingClientRect();document.body.append(s),s.style.left=o+5+"px",s.style.top=i+e.offsetHeight/2-s.offsetHeight/2+"px"}removeTooltip(){const t=document.querySelector(".tooltip");t&&t.remove()}}})();